Microsoft Defender XDR - WorkshopPLUS

LINK: https://mslearningcampus.com/User/Login
STUDENT KEY: 


Enhanced The lab
----------------
MDE
 - Updated CLIENT01 Platform to Version: 4.18.25100.9006 (is now green!)
   - https://www.catalog.update.microsoft.com/Search.aspx?q=KB4052623
 - Updated Firefox, PowerShell, and Edge to show Threat Vuln Management at work
   - https://learn.microsoft.com/en-us/powershell/scripting/install/installing-powershell-on-windows?view=powershell-7.5#msi
 - Installed RSAT on Windows 11 VM: 
 - Turned on ASR AuditMode as GPO (linked)
 - Turned on ExploitGuard in AuditMode as GPO (linked)
 - Turned on Network Protection in AuditMode as GPO (linked)
 - Turned on MDE Auditing as GPO
 - Increased size of Security Log from 20MB to 1GB
 - Turned on BAF, Hashing, Behavior Analytics, MAPS, Cloud Protection, Archive Scanning



---------------------- ENHANCE LAB -------------------------------

# Install RSAT tools for Windows 11
Get-WindowsCapability -Name RSAT* -Online | Add-WindowsCapability -Online

# Validate RSAT tools are installed
Get-WindowsCapability -Name RSAT* -Online | Where-Object {$_.State -eq "Installed" }

# Import Active Directory Module (RSAT)
Import-Module ActiveDirectory

# Create a basic OU structure (Workstations)
New-ADOrganizationalUnit -Name "Workstations" -Path "DC=yourdomain,DC=com"

# Move all computers from the Computers container to Workstations OU
Get-ADComputer -Filter * -SearchBase "CN=Computers,DC=contoso,DC=local" | Move-ADObject -TargetPath "OU=Workstations,DC=contoso,DC=local"

# Run MDE AuditPolicy script and link to Workstations OU and Domain Controllers OU
.\Create-MDE-AuditPolicyGPO.ps1 -GPOName "MDE Audit Policy - Workstations" -TargetOU "OU=Workstations,DC=contoso,DC=local"

.\Create-MDE-AuditPolicyGPO.ps1 -GPOName "MDE Audit Policy - Domain Controllers" -TargetOU "OU=Domain Controllers,DC=contoso,DC=local"

# Set Security log to 1GB on your client GPO
Set-GPRegistryValue -Name "MDE Audit Policy - Workstations" -Key "HKLM\SOFTWARE\Policies\Microsoft\Windows\EventLog\Security" -ValueName "MaxSize" -Type DWord -Value 1048576

# Set Security log to 1GB on your DC GPO
Set-GPRegistryValue -Name "MDE Audit Policy - Domain Controllers" -Key "HKLM\SOFTWARE\Policies\Microsoft\Windows\EventLog\Security" -ValueName "MaxSize" -Type DWord -Value 1048576

# On the client computer, force GPO update
gpupdate /force

# Verify the audit settings applied
auditpol /get /category:*


----------------------------------
CONFIGURE ASR / AUDIT MODE
----------------------------------
# Run the ASR Audit PS Script, it will create the GPO and Link it




# Pre-req's for NetworkProtection
# Must have MDE P2
# MDAV MUST be in Active Mode
# Cloud-Delivered Protection MUST be enabled.
# Can be enabled in 'Enabled' (Block) or AuditMode (Audit)
# I set this in the GPO and on the CLI.
Set-MpPreference -EnableNetworkProtection AuditMode

Get-MpPreference | Select-Object EnableNetworkProtection




# Look for ASR events that triggered on endpoint ..you can also look in XDR -> Assets -> Device -> CLIENT01 -> Incidents & Timeline
Get-WinEvent -LogName "Microsoft-Windows-Windows Defender/Operational"  | Where-Object {$_.Id -eq 1121 -or $_.Id -eq 1122}


ON THE DC
---------------------------
EXPLOIT GUARD / AUDIT MODE
---------------------------
New-SmbShare -Name "GPO-Configs" -Path "C:\GPO-Configs" -ReadAccess "Domain Computers"

VSCode -> ExploitProtectionLite.xml
--------------------------------------------




---------------------------------------

Behavioral Monitoring
Microsoft Active Protection Service (MAPS) -> Enabled (Advanced Subscription)
  - Online community used to stop the spread of new malicious software infections.
Scan all downloaded files and attachments
Raw Vol Write Notifications
Turn on process scanning whenever real-time protection is enabled
Turn on script scanning
Scan Archives w/ depth of 10
Scan Email
Scan packed executables
Enable File Hash computation feature
Configure extended cloud check
Select Cloud Protection Level = Moderate Blocking Protection
Network Inspection System
  - Allow Network Protection to be in block or audit settings
  - Turn on protocol recognition






