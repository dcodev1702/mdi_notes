#Requires -Modules GroupPolicy<#.SYNOPSIS    Creates a GPO with comprehensive audit policy settings optimized for Microsoft Defender for Endpoint (MDE).
.DESCRIPTION    This script creates a new Group Policy Object with audit policy settings that enable    comprehensive logging for MDE to maximize EDR visibility and detection capabilities.    The settings are based on MDE requirements and security best practices..PARAMETER GPOName    Name of the GPO to create. Default: "MDE Audit Policy - Clients".PARAMETER TargetOU    Distinguished Name of the OU to link the GPO to. If not specified, GPO is created but not linked..PARAMETER LinkEnabled    Whether to enable the GPO link immediately. Default: $true.EXAMPLE    .\Create-MDE-AuditPolicyGPO.ps1.EXAMPLE    .\Create-MDE-AuditPolicyGPO.ps1 -GPOName "Custom MDE Audit" -TargetOU "OU=Workstations,DC=contoso,DC=com".NOTES    Author: Generated for MDE Audit Policy Configuration    Requires: Active Directory PowerShell Module, Group Policy Management    Run as: Domain Administrator or user with GPO creation rights#>[CmdletBinding()]param(    [Parameter(Mandatory=$false)]    [string]$GPOName = "MDE Audit Policy - Clients",        [Parameter(Mandatory=$false)]    [string]$TargetOU,        [Parameter(Mandatory=$false)]    [bool]$LinkEnabled = $true)# Check for required modulesif (-not (Get-Module -ListAvailable -Name GroupPolicy)) {    Write-Error "GroupPolicy module not found. Install RSAT Group Policy Management Tools."    exit 1}Import-Module GroupPolicy# Audit policy settings optimized for MDE# Format: SubcategoryName, Success (enable/disable), Failure (enable/disable)$AuditSettings = @(    # Account Logon    @{Category="Account Logon"; Subcategory="Credential Validation"; Success="enable"; Failure="enable"},    @{Category="Account Logon"; Subcategory="Kerberos Authentication Service"; Success="enable"; Failure="enable"},    @{Category="Account Logon"; Subcategory="Kerberos Service Ticket Operations"; Success="disable"; Failure="enable"},    @{Category="Account Logon"; Subcategory="Other Account Logon Events"; Success="enable"; Failure="enable"},    # Account Management    @{Category="Account Management"; Subcategory="User Account Management"; Success="enable"; Failure="enable"},    @{Category="Account Management"; Subcategory="Computer Account Management"; Success="enable"; Failure="enable"},    @{Category="Account Management"; Subcategory="Security Group Management"; Success="enable"; Failure="enable"},    @{Category="Account Management"; Subcategory="Distribution Group Management"; Success="enable"; Failure="enable"},    @{Category="Account Management"; Subcategory="Application Group Management"; Success="enable"; Failure="enable"},    @{Category="Account Management"; Subcategory="Other Account Management Events"; Success="enable"; Failure="enable"},    # Detailed Tracking - CRITICAL for EDR    @{Category="Detailed Tracking"; Subcategory="Process Creation"; Success="enable"; Failure="enable"},    @{Category="Detailed Tracking"; Subcategory="Process Termination"; Success="enable"; Failure="disable"},    @{Category="Detailed Tracking"; Subcategory="DPAPI Activity"; Success="enable"; Failure="enable"},    @{Category="Detailed Tracking"; Subcategory="Plug and Play Events"; Success="enable"; Failure="disable"},    @{Category="Detailed Tracking"; Subcategory="Token Right Adjusted Events"; Success="enable"; Failure="disable"},    # Logon/Logoff    @{Category="Logon/Logoff"; Subcategory="Logon"; Success="enable"; Failure="enable"},    @{Category="Logon/Logoff"; Subcategory="Logoff"; Success="enable"; Failure="disable"},    @{Category="Logon/Logoff"; Subcategory="Account Lockout"; Success="enable"; Failure="enable"},    @{Category="Logon/Logoff"; Subcategory="Special Logon"; Success="enable"; Failure="enable"},    @{Category="Logon/Logoff"; Subcategory="Other Logon/Logoff Events"; Success="enable"; Failure="enable"},    @{Category="Logon/Logoff"; Subcategory="Network Policy Server"; Success="enable"; Failure="enable"},    @{Category="Logon/Logoff"; Subcategory="User / Device Claims"; Success="enable"; Failure="disable"},    @{Category="Logon/Logoff"; Subcategory="Group Membership"; Success="enable"; Failure="disable"},    # Object Access    @{Category="Object Access"; Subcategory="File System"; Success="disable"; Failure="enable"},    @{Category="Object Access"; Subcategory="Registry"; Success="disable"; Failure="enable"},    @{Category="Object Access"; Subcategory="Kernel Object"; Success="disable"; Failure="enable"},    @{Category="Object Access"; Subcategory="SAM"; Success="disable"; Failure="enable"},    @{Category="Object Access"; Subcategory="Certification Services"; Success="enable"; Failure="enable"},    @{Category="Object Access"; Subcategory="Application Generated"; Success="enable"; Failure="enable"},    @{Category="Object Access"; Subcategory="Handle Manipulation"; Success="disable"; Failure="disable"},    @{Category="Object Access"; Subcategory="File Share"; Success="enable"; Failure="enable"},    @{Category="Object Access"; Subcategory="Filtering Platform Packet Drop"; Success="enable"; Failure="enable"},    @{Category="Object Access"; Subcategory="Filtering Platform Connection"; Success="enable"; Failure="enable"},    @{Category="Object Access"; Subcategory="Other Object Access Events"; Success="enable"; Failure="enable"},    @{Category="Object Access"; Subcategory="Detailed File Share"; Success="enable"; Failure="enable"},    @{Category="Object Access"; Subcategory="Removable Storage"; Success="enable"; Failure="enable"},    @{Category="Object Access"; Subcategory="Central Policy Staging"; Success="disable"; Failure="disable"},    # Policy Change    @{Category="Policy Change"; Subcategory="Audit Policy Change"; Success="enable"; Failure="enable"},    @{Category="Policy Change"; Subcategory="Authentication Policy Change"; Success="enable"; Failure="enable"},    @{Category="Policy Change"; Subcategory="Authorization Policy Change"; Success="enable"; Failure="enable"},    @{Category="Policy Change"; Subcategory="MPSSVC Rule-Level Policy Change"; Success="enable"; Failure="enable"},    @{Category="Policy Change"; Subcategory="Filtering Platform Policy Change"; Success="enable"; Failure="enable"},    @{Category="Policy Change"; Subcategory="Other Policy Change Events"; Success="enable"; Failure="enable"},    # Privilege Use    @{Category="Privilege Use"; Subcategory="Sensitive Privilege Use"; Success="enable"; Failure="enable"},    @{Category="Privilege Use"; Subcategory="Non Sensitive Privilege Use"; Success="disable"; Failure="disable"},    @{Category="Privilege Use"; Subcategory="Other Privilege Use Events"; Success="disable"; Failure="disable"},    # System    @{Category="System"; Subcategory="Security State Change"; Success="enable"; Failure="enable"},    @{Category="System"; Subcategory="Security System Extension"; Success="enable"; Failure="enable"},    @{Category="System"; Subcategory="System Integrity"; Success="enable"; Failure="enable"},    @{Category="System"; Subcategory="IPsec Driver"; Success="enable"; Failure="enable"},    @{Category="System"; Subcategory="Other System Events"; Success="enable"; Failure="enable"})Write-Host "`n========================================" -ForegroundColor CyanWrite-Host "MDE Audit Policy GPO Configuration" -ForegroundColor CyanWrite-Host "========================================`n" -ForegroundColor Cyan# Create the GPOWrite-Host "[*] Creating GPO: $GPOName" -ForegroundColor Yellowtry {    $GPO = Get-GPO -Name $GPOName -ErrorAction SilentlyContinue    if ($GPO) {        Write-Host "    GPO already exists. Using existing GPO." -ForegroundColor Yellow    } else {        $GPO = New-GPO -Name $GPOName -Comment "Audit policy settings optimized for Microsoft Defender for Endpoint (MDE). Enables comprehensive logging for EDR visibility."        Write-Host "    GPO created successfully." -ForegroundColor Green    }} catch {    Write-Error "Failed to create GPO: $_"    exit 1}# Create temporary audit policy CSV$TempPath = [System.IO.Path]::GetTempPath()$AuditCSVPath = Join-Path $TempPath "mde-audit-policy.csv"Write-Host "`n[*] Generating audit policy configuration..." -ForegroundColor Yellow# Build CSV content$CSVContent = "Machine Name,Policy Target,Subcategory,Subcategory GUID,Inclusion Setting,Exclusion Setting,Setting Value`r`n"foreach ($setting in $AuditSettings) {    # Get subcategory GUID    $subcatInfo = auditpol /list /subcategory:"$($setting.Subcategory)" /v 2>$null | Where-Object { $_ -match '\{[0-9A-F\-]+\}' }        if ($subcatInfo -match '\{([0-9A-F\-]+)\}') {        $guid = "{$($matches[1])}"                # Calculate setting value        # 0 = No Auditing, 1 = Success, 2 = Failure, 3 = Success and Failure        $settingValue = 0        if ($setting.Success -eq "enable" -and $setting.Failure -eq "enable") { $settingValue = 3 }        elseif ($setting.Success -eq "enable") { $settingValue = 1 }        elseif ($setting.Failure -eq "enable") { $settingValue = 2 }                $CSVContent += ",$($setting.Category),$($setting.Subcategory),$guid,,$settingValue`r`n"                Write-Host "    [+] $($setting.Subcategory): " -NoNewline -ForegroundColor Gray        switch ($settingValue) {            0 { Write-Host "No Auditing" -ForegroundColor DarkGray }            1 { Write-Host "Success" -ForegroundColor Green }            2 { Write-Host "Failure" -ForegroundColor Yellow }            3 { Write-Host "Success and Failure" -ForegroundColor Cyan }        }    }}# Save CSV$CSVContent | Out-File -FilePath $AuditCSVPath -Encoding ASCII -Force# Get GPO path$GPOPath = "\\$env:USERDNSDOMAIN\SYSVOL\$env:USERDNSDOMAIN\Policies\{$($GPO.Id)}\Machine\Microsoft\Windows NT\Audit"Write-Host "`n[*] Applying audit policy to GPO..." -ForegroundColor Yellow# Create audit directory in GPO if it doesn't existif (-not (Test-Path $GPOPath)) {    New-Item -Path $GPOPath -ItemType Directory -Force | Out-Null}# Copy audit CSV to GPOCopy-Item -Path $AuditCSVPath -Destination "$GPOPath\audit.csv" -Force# Update GPO version to trigger refresh$GPO = Get-GPO -Name $GPOName$GPORegistryPath = "\\$env:USERDNSDOMAIN\SYSVOL\$env:USERDNSDOMAIN\Policies\{$($GPO.Id)}\GPT.INI"if (Test-Path $GPORegistryPath) {    $GPTContent = Get-Content $GPORegistryPath    $versionLine = $GPTContent | Where-Object { $_ -match "Version=" }        if ($versionLine -match "Version=(\d+)") {        $currentVersion = [int]$matches[1]        $newVersion = $currentVersion + 65536  # Increment computer version        $GPTContent = $GPTContent -replace "Version=\d+", "Version=$newVersion"        $GPTContent | Set-Content $GPORegistryPath -Force    }}Write-Host "    Audit policy applied successfully." -ForegroundColor Green# Configure additional PowerShell logging for MDEWrite-Host "`n[*] Configuring PowerShell logging..." -ForegroundColor Yellowtry {    # Enable PowerShell Script Block Logging    Set-GPRegistryValue -Name $GPOName -Key "HKLM\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging" -ValueName "EnableScriptBlockLogging" -Type DWord -Value 1 | Out-Null        # Enable PowerShell Module Logging    Set-GPRegistryValue -Name $GPOName -Key "HKLM\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ModuleLogging" -ValueName "EnableModuleLogging" -Type DWord -Value 1 | Out-Null        Write-Host "    PowerShell logging enabled." -ForegroundColor Green} catch {    Write-Warning "Failed to configure PowerShell logging: $_"}# Configure Process Creation to include command lineWrite-Host "`n[*] Configuring Process Creation command line logging..." -ForegroundColor Yellowtry {    Set-GPRegistryValue -Name $GPOName -Key "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\Audit" -ValueName "ProcessCreationIncludeCmdLine_Enabled" -Type DWord -Value 1 | Out-Null    Write-Host "    Process command line logging enabled." -ForegroundColor Green} catch {    Write-Warning "Failed to configure process command line logging: $_"}# Link to OU if specifiedif ($TargetOU) {    Write-Host "`n[*] Linking GPO to OU: $TargetOU" -ForegroundColor Yellow    try {        $link = New-GPLink -Name $GPOName -Target $TargetOU -LinkEnabled $(if ($LinkEnabled) { "Yes" } else { "No" }) -ErrorAction Stop        Write-Host "    GPO linked successfully." -ForegroundColor Green        if (-not $LinkEnabled) {            Write-Host "    (Link is currently disabled)" -ForegroundColor Yellow        }    } catch {        Write-Warning "Failed to link GPO: $_"    }}# Clean up temp fileRemove-Item $AuditCSVPath -Force -ErrorAction SilentlyContinue# SummaryWrite-Host "`n========================================" -ForegroundColor CyanWrite-Host "Configuration Complete!" -ForegroundColor GreenWrite-Host "========================================" -ForegroundColor CyanWrite-Host "`nGPO Details:" -ForegroundColor WhiteWrite-Host "  Name: $($GPO.DisplayName)" -ForegroundColor GrayWrite-Host "  GUID: {$($GPO.Id)}" -ForegroundColor GrayWrite-Host "  Created: $($GPO.CreationTime)" -ForegroundColor GrayWrite-Host "  Modified: $($GPO.ModificationTime)" -ForegroundColor Grayif ($TargetOU) {    Write-Host "`nGPO Link:" -ForegroundColor White    Write-Host "  Target OU: $TargetOU" -ForegroundColor Gray    Write-Host "  Link Enabled: $LinkEnabled" -ForegroundColor Gray} else {    Write-Host "`nNote: GPO created but not linked. Link manually to desired OU." -ForegroundColor Yellow}Write-Host "`nNext Steps:" -ForegroundColor WhiteWrite-Host "  1. Review the GPO settings in Group Policy Management Console" -ForegroundColor GrayWrite-Host "  2. Run 'gpupdate /force' on target clients to apply immediately" -ForegroundColor GrayWrite-Host "  3. Verify audit settings with: auditpol /get /category:*" -ForegroundColor GrayWrite-Host "  4. Monitor Security event log size and adjust if needed (recommend 1GB+)" -ForegroundColor GrayWrite-Host "`n"# Optional: Generate report$ReportPath = Join-Path $PSScriptRoot "GPO-Report-$($GPOName -replace ' ','-').html"Write-Host "[*] Generating GPO report to: $ReportPath" -ForegroundColor Yellowtry {    Get-GPOReport -Name $GPOName -ReportType HTML -Path $ReportPath    Write-Host "    Report generated successfully." -ForegroundColor Green} catch {    Write-Warning "Failed to generate report: $_"}
