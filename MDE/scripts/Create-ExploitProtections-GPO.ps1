<#
    Author: DCODEV1702 & Claude Sonnet 4.5
    Date: 16 Nov 2025
    
    .SYNOPSIS
    Creates and configures a Group Policy Object for Microsoft Defender Exploit Protection and Advanced Features.
    
    .DESCRIPTION
    This script creates or updates a GPO that enables comprehensive Microsoft Defender protection features
    including cloud protection, network protection, controlled folder access, exploit protection, and 
    advanced scanning capabilities. The GPO is configured for audit-friendly deployment with Network 
    Protection and Controlled Folder Access in audit mode.
    
    The script performs the following configurations:
    
    MICROSOFT MAPS & CLOUD PROTECTION:
    - Advanced MAPS reporting for maximum threat intelligence
    - Block at First Sight (BAFS) for zero-day protection
    - Automatic sample submission (all samples)
    - Extended cloud check timeout (10 seconds)
    - File hash computation for rapid reputation lookups
    - Real-time security intelligence updates
    
    NETWORK PROTECTION:
    - Network Protection in Audit mode (logs dangerous website access)
    - Protocol recognition enabled
    - Datagram processing enabled
    - Windows Server support enabled
    
    CONTROLLED FOLDER ACCESS:
    - Ransomware protection in Audit mode
    - Monitors unauthorized file modification attempts
    
    REAL-TIME PROTECTION & SCANNING:
    - Behavior monitoring
    - Process scanning
    - Script scanning (PowerShell, JavaScript, VBScript)
    - Downloaded files and attachments scanning (max 20 MB)
    - File and program activity monitoring
    - Raw volume write detection (ransomware indicator)
    
    SCHEDULED SCAN CONFIGURATION:
    - Quick scans twice daily
    - Archive scanning (depth 5 levels)
    - Packed executable scanning
    - Removable drive scanning
    - Email scanning
    - Heuristics enabled
    - Pre-scan signature updates
    
    EXPLOIT PROTECTION:
    - References centralized XML configuration file
    - Path: \\DC\GPO-Configs\ExploitProtectionLite.xml
    - Applies system-wide and per-application mitigations
    
    MICROSOFT DEFENDER APPLICATION GUARD:
    - Auditing events enabled for isolated browsing sessions
    
    .PARAMETER GPOName
    Name of the Group Policy Object to create or update.
    Default: "Exploit-Protections-Workstations"
    
    .PARAMETER OU
    Distinguished Name of the Organizational Unit to link the GPO to.
    Default: "OU=Workstations,DC=contoso,DC=local"
    
    .PARAMETER ExploitProtectionXMLPath
    UNC path to the ExploitProtectionLite.xml configuration file.
    Default: "\\DC\GPO-Configs\ExploitProtectionLite.xml"
    
    .EXAMPLE
    .\Create-ExploitProtection-GPO.ps1
    
    Creates the Exploit Protection GPO with default settings and links it to the Workstations OU.
    
    .EXAMPLE
    .\Create-ExploitProtection-GPO.ps1 -GPOName "MDE-Exploit-Protections" -OU "OU=Workstations,DC=contoso,DC=local"
    
    Creates a custom-named GPO and links it to a different OU.
    
    .EXAMPLE
    .\Create-ExploitProtection-GPO.ps1 -ExploitProtectionXMLPath "\\DC\GPO-Configs\ExploitProtectionLite.xml"
    
    Creates the GPO with a custom UNC path to the Exploit Protection XML file.
    
    .NOTES
    Requirements:
    - RSAT Group Policy Management Tools (GroupPolicy PowerShell module)
    - Domain Administrator or equivalent permissions
    - Run from Domain Controller or system with RSAT installed
    - ExploitProtectionLite.xml file must be accessible via network share
    
    Prerequisites:
    1. Create SMB share "GPO-Configs" on Domain Controller
    2. Copy ExploitProtectionLite.xml to C:\GPO-Configs\
    3. Configure share permissions (Domain Computers: Read)
    
    After deployment:
    1. Run 'gpupdate /force' on target workstations
    2. Verify settings: Get-MpPreference | Format-List
    3. Monitor Network Protection events (Event ID 1125 = Audit, 1126 = Block)
    4. Monitor Controlled Folder Access events (Event ID 1123 = Audit, 1124 = Block)
    5. Review audit logs for 30+ days before transitioning to Block mode
    
    To transition to Block mode:
    - Network Protection: Change value from 2 (Audit) to 1 (Block)
    - Controlled Folder Access: Change value from 2 (Audit) to 1 (Block)
    
    Microsoft Documentation:
    https://learn.microsoft.com/en-us/microsoft-365/security/defender-endpoint/enable-exploit-protection
    https://learn.microsoft.com/en-us/microsoft-365/security/defender-endpoint/enable-network-protection
#>

[CmdletBinding()]
param(
    [Parameter(Mandatory=$false)]
    [string]$GPOName = "Exploit-Protections-Workstations",
    
    [Parameter(Mandatory=$false)]
    [string]$OU = "OU=Workstations,DC=contoso,DC=local",
    
    [Parameter(Mandatory=$false)]
    [string]$ExploitProtectionXMLPath = "\\DC\GPO-Configs\ExploitProtectionLite.xml"
)

# Import required module
Import-Module GroupPolicy

Write-Host "`n========================================" -ForegroundColor Cyan
Write-Host "Exploit Protection GPO Configuration" -ForegroundColor Cyan
Write-Host "========================================`n" -ForegroundColor Cyan

# Create new GPO or use existing
Write-Host "[*] Checking for GPO: $GPOName" -ForegroundColor Yellow
try {
    $GPO = Get-GPO -Name $GPOName -ErrorAction Stop
    Write-Host "    GPO already exists. Using existing GPO." -ForegroundColor Yellow
} catch {
    Write-Host "    GPO does not exist. Creating new GPO..." -ForegroundColor Yellow
    $GPO = New-GPO -Name $GPOName
    Write-Host "    GPO created successfully." -ForegroundColor Green
    
    # Link to OU
    Write-Host "    Linking GPO to OU: $OU" -ForegroundColor Yellow
    New-GPLink -Name $GPOName -Target $OU -LinkEnabled Yes -Enforced Yes
    Write-Host "    GPO linked and enforced successfully." -ForegroundColor Green
}

#region Microsoft MAPS & Cloud Protection
Write-Host "`n[*] Configuring Microsoft MAPS & Cloud Protection..." -ForegroundColor Yellow

# Advanced MAPS reporting
Set-GPRegistryValue -Name $GPOName -Key "HKLM\Software\Policies\Microsoft\Windows Defender\Spynet" -ValueName "SpynetReporting" -Type DWord -Value 2 | Out-Null
Write-Host "    [+] MAPS Reporting: Advanced (2)" -ForegroundColor Gray

# Send all samples automatically
Set-GPRegistryValue -Name $GPOName -Key "HKLM\Software\Policies\Microsoft\Windows Defender\Spynet" -ValueName "SubmitSamplesConsent" -Type DWord -Value 3 | Out-Null
Write-Host "    [+] Submit Samples Consent: Send all samples (3)" -ForegroundColor Gray

# Enable Block at First Sight
Set-GPRegistryValue -Name $GPOName -Key "HKLM\Software\Policies\Microsoft\Windows Defender\Spynet" -ValueName "DisableBlockAtFirstSeen" -Type DWord -Value 0 | Out-Null
Write-Host "    [+] Block at First Sight: Enabled" -ForegroundColor Gray

# Extended cloud check timeout (10 seconds)
Set-GPRegistryValue -Name $GPOName -Key "HKLM\Software\Policies\Microsoft\Windows Defender\MpEngine" -ValueName "MpCloudBlockLevel" -Type DWord -Value 0 | Out-Null
Set-GPRegistryValue -Name $GPOName -Key "HKLM\Software\Policies\Microsoft\Windows Defender\MpEngine" -ValueName "MpBafsExtendedTimeout" -Type DWord -Value 10 | Out-Null
Write-Host "    [+] Extended Cloud Check: 10 seconds" -ForegroundColor Gray

# Enable file hash computation
Set-GPRegistryValue -Name $GPOName -Key "HKLM\Software\Policies\Microsoft\Windows Defender\MpEngine" -ValueName "EnableFileHashComputation" -Type DWord -Value 1 | Out-Null
Write-Host "    [+] File Hash Computation: Enabled" -ForegroundColor Gray

# Allow real-time security intelligence updates based on MAPS
Set-GPRegistryValue -Name $GPOName -Key "HKLM\Software\Policies\Microsoft\Windows Defender\Signature Updates" -ValueName "RealtimeSignatureDelivery" -Type DWord -Value 1 | Out-Null
Write-Host "    [+] Real-time Security Intelligence Updates: Enabled" -ForegroundColor Gray

Write-Host "    Microsoft MAPS & Cloud Protection configured." -ForegroundColor Green
#endregion

#region Network Protection
Write-Host "`n[*] Configuring Network Protection..." -ForegroundColor Yellow

# Enable Network Protection in Audit mode (2 = Audit, 1 = Block, 0 = Disabled)
Set-GPRegistryValue -Name $GPOName -Key "HKLM\Software\Policies\Microsoft\Windows Defender\Windows Defender Exploit Guard\Network Protection" -ValueName "EnableNetworkProtection" -Type DWord -Value 2 | Out-Null
Write-Host "    [+] Network Protection: Audit Mode (2)" -ForegroundColor Gray

# Enable Network Protection on Windows Server
Set-GPRegistryValue -Name $GPOName -Key "HKLM\Software\Policies\Microsoft\Windows Defender\Windows Defender Exploit Guard\Network Protection" -ValueName "AllowNetworkProtectionOnWinServer" -Type DWord -Value 1 | Out-Null
Write-Host "    [+] Network Protection on Windows Server: Enabled" -ForegroundColor Gray

# Enable Protocol Recognition
Set-GPRegistryValue -Name $GPOName -Key "HKLM\Software\Policies\Microsoft\Windows Defender\NIS" -ValueName "DisableProtocolRecognition" -Type DWord -Value 0 | Out-Null
Write-Host "    [+] Protocol Recognition: Enabled" -ForegroundColor Gray

# Enable Datagram Processing for Network Protection
Set-GPRegistryValue -Name $GPOName -Key "HKLM\Software\Policies\Microsoft\Windows Defender\Windows Defender Exploit Guard\Network Protection" -ValueName "AllowNetworkProtectionDownLevel" -Type DWord -Value 1 | Out-Null
Write-Host "    [+] Datagram Processing: Enabled" -ForegroundColor Gray

Write-Host "    Network Protection configured." -ForegroundColor Green
#endregion

#region Controlled Folder Access
Write-Host "`n[*] Configuring Controlled Folder Access (Ransomware Protection)..." -ForegroundColor Yellow

# Enable Controlled Folder Access in Audit mode (2 = Audit, 1 = Block, 0 = Disabled)
Set-GPRegistryValue -Name $GPOName -Key "HKLM\Software\Policies\Microsoft\Windows Defender\Windows Defender Exploit Guard\Controlled Folder Access" -ValueName "EnableControlledFolderAccess" -Type DWord -Value 2 | Out-Null
Write-Host "    [+] Controlled Folder Access: Audit Mode (2)" -ForegroundColor Gray

Write-Host "    Controlled Folder Access configured." -ForegroundColor Green
#endregion

#region Real-Time Protection & Scanning
Write-Host "`n[*] Configuring Real-Time Protection & Scanning..." -ForegroundColor Yellow

# Enable behavior monitoring
Set-GPRegistryValue -Name $GPOName -Key "HKLM\Software\Policies\Microsoft\Windows Defender\Real-Time Protection" -ValueName "DisableBehaviorMonitoring" -Type DWord -Value 0 | Out-Null
Write-Host "    [+] Behavior Monitoring: Enabled" -ForegroundColor Gray

# Enable process scanning
Set-GPRegistryValue -Name $GPOName -Key "HKLM\Software\Policies\Microsoft\Windows Defender\Real-Time Protection" -ValueName "DisableScanOnRealtimeEnable" -Type DWord -Value 0 | Out-Null
Write-Host "    [+] Process Scanning: Enabled" -ForegroundColor Gray

# Enable script scanning
Set-GPRegistryValue -Name $GPOName -Key "HKLM\Software\Policies\Microsoft\Windows Defender\Real-Time Protection" -ValueName "DisableScriptScanning" -Type DWord -Value 0 | Out-Null
Write-Host "    [+] Script Scanning: Enabled" -ForegroundColor Gray

# Scan downloaded files and attachments
Set-GPRegistryValue -Name $GPOName -Key "HKLM\Software\Policies\Microsoft\Windows Defender\Real-Time Protection" -ValueName "DisableIOAVProtection" -Type DWord -Value 0 | Out-Null
Write-Host "    [+] Downloaded Files Scanning: Enabled" -ForegroundColor Gray

# Set maximum file size to scan (20 MB = 20480 KB)
Set-GPRegistryValue -Name $GPOName -Key "HKLM\Software\Policies\Microsoft\Windows Defender\Scan" -ValueName "AvgCPULoadFactor" -Type DWord -Value 20480 | Out-Null
Write-Host "    [+] Max Download Size to Scan: 20 MB" -ForegroundColor Gray

# Enable file and program activity monitoring
Set-GPRegistryValue -Name $GPOName -Key "HKLM\Software\Policies\Microsoft\Windows Defender\Real-Time Protection" -ValueName "DisableOnAccessProtection" -Type DWord -Value 0 | Out-Null
Write-Host "    [+] File and Program Activity Monitoring: Enabled" -ForegroundColor Gray

# Enable raw volume write notifications (ransomware detection)
Set-GPRegistryValue -Name $GPOName -Key "HKLM\Software\Policies\Microsoft\Windows Defender\Real-Time Protection" -ValueName "DisableRawWriteNotification" -Type DWord -Value 0 | Out-Null
Write-Host "    [+] Raw Volume Write Notifications: Enabled" -ForegroundColor Gray

Write-Host "    Real-Time Protection & Scanning configured." -ForegroundColor Green
#endregion

#region Scheduled Scan Configuration
Write-Host "`n[*] Configuring Scheduled Scan Settings..." -ForegroundColor Yellow

# Quick scans per day (2 times)
Set-GPRegistryValue -Name $GPOName -Key "HKLM\Software\Policies\Microsoft\Windows Defender\Scan" -ValueName "QuickScanInterval" -Type DWord -Value 2 | Out-Null
Write-Host "    [+] Quick Scans Per Day: 2" -ForegroundColor Gray

# Enable archive scanning with depth 5
Set-GPRegistryValue -Name $GPOName -Key "HKLM\Software\Policies\Microsoft\Windows Defender\Scan" -ValueName "DisableArchiveScanning" -Type DWord -Value 0 | Out-Null
Set-GPRegistryValue -Name $GPOName -Key "HKLM\Software\Policies\Microsoft\Windows Defender\Scan" -ValueName "ArchiveMaxDepth" -Type DWord -Value 5 | Out-Null
Write-Host "    [+] Archive Scanning: Enabled (Depth: 5)" -ForegroundColor Gray

# Enable packed executable scanning
Set-GPRegistryValue -Name $GPOName -Key "HKLM\Software\Policies\Microsoft\Windows Defender\Scan" -ValueName "DisablePackedExeScanning" -Type DWord -Value 0 | Out-Null
Write-Host "    [+] Packed Executable Scanning: Enabled" -ForegroundColor Gray

# Enable removable drive scanning
Set-GPRegistryValue -Name $GPOName -Key "HKLM\Software\Policies\Microsoft\Windows Defender\Scan" -ValueName "DisableRemovableDriveScanning" -Type DWord -Value 0 | Out-Null
Write-Host "    [+] Removable Drive Scanning: Enabled" -ForegroundColor Gray

# Enable email scanning
Set-GPRegistryValue -Name $GPOName -Key "HKLM\Software\Policies\Microsoft\Windows Defender\Scan" -ValueName "DisableEmailScanning" -Type DWord -Value 0 | Out-Null
Write-Host "    [+] Email Scanning: Enabled" -ForegroundColor Gray

# Enable heuristics
Set-GPRegistryValue -Name $GPOName -Key "HKLM\Software\Policies\Microsoft\Windows Defender\Scan" -ValueName "DisableHeuristics" -Type DWord -Value 0 | Out-Null
Write-Host "    [+] Heuristics: Enabled" -ForegroundColor Gray

# Check for latest signatures before scheduled scan
Set-GPRegistryValue -Name $GPOName -Key "HKLM\Software\Policies\Microsoft\Windows Defender\Scan" -ValueName "CheckForSignaturesBeforeRunningScan" -Type DWord -Value 1 | Out-Null
Write-Host "    [+] Pre-Scan Signature Updates: Enabled" -ForegroundColor Gray

Write-Host "    Scheduled Scan Configuration complete." -ForegroundColor Green
#endregion

#region Exploit Protection
Write-Host "`n[*] Configuring Exploit Protection..." -ForegroundColor Yellow

# Set path to Exploit Protection XML configuration file
Set-GPRegistryValue -Name $GPOName -Key "HKLM\Software\Policies\Microsoft\Windows Defender\Windows Defender Exploit Guard\Exploit Protection" -ValueName "ExploitProtectionSettings" -Type String -Value $ExploitProtectionXMLPath | Out-Null
Write-Host "    [+] Exploit Protection XML Path: $ExploitProtectionXMLPath" -ForegroundColor Gray

Write-Host "    Exploit Protection configured." -ForegroundColor Green
Write-Host "    NOTE: Ensure the XML file is accessible at: $ExploitProtectionXMLPath" -ForegroundColor Yellow
#endregion

#region Microsoft Defender Application Guard
Write-Host "`n[*] Configuring Microsoft Defender Application Guard..." -ForegroundColor Yellow

# Enable Application Guard auditing events
Set-GPRegistryValue -Name $GPOName -Key "HKLM\Software\Policies\Microsoft\AppHVSI" -ValueName "AuditApplicationGuard" -Type DWord -Value 1 | Out-Null
Write-Host "    [+] Application Guard Auditing: Enabled" -ForegroundColor Gray

Write-Host "    Microsoft Defender Application Guard configured." -ForegroundColor Green
#endregion

Write-Host "`n========================================" -ForegroundColor Cyan
Write-Host "Configuration Complete!" -ForegroundColor Green
Write-Host "========================================" -ForegroundColor Cyan

Write-Host "`nGPO Details:" -ForegroundColor White
Write-Host "  Name: $($GPO.DisplayName)" -ForegroundColor Gray
Write-Host "  GUID: {$($GPO.Id)}" -ForegroundColor Gray
Write-Host "  Linked to: $OU" -ForegroundColor Gray

Write-Host "`nConfigured Features:" -ForegroundColor White
Write-Host "  [✓] Microsoft MAPS (Advanced)" -ForegroundColor Gray
Write-Host "  [✓] Block at First Sight" -ForegroundColor Gray
Write-Host "  [✓] Automatic Sample Submission (All samples)" -ForegroundColor Gray
Write-Host "  [✓] Extended Cloud Check (10 seconds)" -ForegroundColor Gray
Write-Host "  [✓] File Hash Computation" -ForegroundColor Gray
Write-Host "  [✓] Network Protection (Audit Mode)" -ForegroundColor Gray
Write-Host "  [✓] Controlled Folder Access (Audit Mode)" -ForegroundColor Gray
Write-Host "  [✓] Behavior Monitoring" -ForegroundColor Gray
Write-Host "  [✓] Script Scanning" -ForegroundColor Gray
Write-Host "  [✓] Quick Scans (2x daily)" -ForegroundColor Gray
Write-Host "  [✓] Archive Scanning (Depth: 5)" -ForegroundColor Gray
Write-Host "  [✓] Exploit Protection XML: $ExploitProtectionXMLPath" -ForegroundColor Gray
Write-Host "  [✓] Application Guard Auditing" -ForegroundColor Gray

Write-Host "`nNext Steps:" -ForegroundColor White
Write-Host "  1. Verify Exploit Protection XML file is accessible:" -ForegroundColor Gray
Write-Host "     Test-Path '$ExploitProtectionXMLPath'" -ForegroundColor Gray
Write-Host "  2. Run 'gpupdate /force' on target workstations" -ForegroundColor Gray
Write-Host "  3. Verify settings on client:" -ForegroundColor Gray
Write-Host "     Get-MpPreference | Format-List" -ForegroundColor Gray
Write-Host "  4. Monitor Network Protection events (Event ID 1125 = Audit)" -ForegroundColor Gray
Write-Host "  5. Monitor Controlled Folder Access events (Event ID 1123 = Audit)" -ForegroundColor Gray
Write-Host "  6. Review audit logs for 30+ days before transitioning to Block mode" -ForegroundColor Gray

Write-Host "`nVerification Commands:" -ForegroundColor White
Write-Host "  # Check MDE status:" -ForegroundColor Gray
Write-Host "  Get-MpComputerStatus | Select-Object RealTimeProtectionEnabled, BehaviorMonitorEnabled, NISEnabled" -ForegroundColor Gray
Write-Host "`n  # Check MAPS configuration:" -ForegroundColor Gray
Write-Host "  Get-MpPreference | Select-Object MAPSReporting, SubmitSamplesConsent, DisableBlockAtFirstSeen" -ForegroundColor Gray
Write-Host "`n  # Check Network Protection:" -ForegroundColor Gray
Write-Host "  Get-MpPreference | Select-Object EnableNetworkProtection" -ForegroundColor Gray
Write-Host "`n  # Check Controlled Folder Access:" -ForegroundColor Gray
Write-Host "  Get-MpPreference | Select-Object EnableControlledFolderAccess" -ForegroundColor Gray
Write-Host "`n  # Check Exploit Protection:" -ForegroundColor Gray
Write-Host "  Get-ProcessMitigation -System" -ForegroundColor Gray
Write-Host "`n  # View Network Protection events:" -ForegroundColor Gray
Write-Host "  Get-WinEvent -LogName 'Microsoft-Windows-Windows Defender/Operational' | Where-Object {`$_.Id -eq 1125}" -ForegroundColor Gray

Write-Host "`nTransition to Block Mode (after 30+ day audit period):" -ForegroundColor Yellow
Write-Host "  # Network Protection - Block mode:" -ForegroundColor Gray
Write-Host "  Set-GPRegistryValue -Name '$GPOName' -Key 'HKLM\Software\Policies\Microsoft\Windows Defender\Windows Defender Exploit Guard\Network Protection' -ValueName 'EnableNetworkProtection' -Type DWord -Value 1" -ForegroundColor Gray
Write-Host "`n  # Controlled Folder Access - Block mode:" -ForegroundColor Gray
Write-Host "  Set-GPRegistryValue -Name '$GPOName' -Key 'HKLM\Software\Policies\Microsoft\Windows Defender\Windows Defender Exploit Guard\Controlled Folder Access' -ValueName 'EnableControlledFolderAccess' -Type DWord -Value 1" -ForegroundColor Gray

Write-Host "`n"
